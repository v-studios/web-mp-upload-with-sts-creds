# Do this in wp-dev since it's for AVAIL, S3 name must be unique
service: multipart-upload-sts
# app and org for use with dashboard.serverless.com
app: getsts
org: vstudios


plugins:
  - serverless-pseudo-parameters

provider:
  name: aws
  runtime: python3.8
  logRetentionInDays: 30        # dont create infinite logs as they cost money
  apiKeys:                      # will be generated by CloudFormation and returned
    - ${self:provider.stage}-client1
    - ${self:provider.stage}-client2
  apiGateway:
    apiKeySourceType: HEADER      # not AUTHORIZER
  environment:
    ROLE_ARN: '#{MultipartUploadRole.Arn}'
    BUCKET_NAME: '#{UploadBucket}'
    BUCKET_ARN: '#{UploadBucket.Arn}'
    # arn:aws:s3:::cshenton-multipart-upload-sts
    BUCKET_REF: !Ref UploadBucket
    ROLE_ATT: !GetAtt [MultipartUploadRole, Arn]

package:
 exclude:
   - package-lock.json
   - node_modules/**

functions:
  GetSts:
    handler: getsts.get
    events:
      - http:
          path: /
          method: get
          private: true # clients must add "x-api-key: APIKEYVAL" to request headers

resources:
 Resources:
   UploadBucket:
     Type: AWS::S3::Bucket
     Properties: 
       BucketName: cshenton-multipart-upload-sts  # in westprime-commercial
   MultipartUploadRole:
     Type: AWS::IAM::Role
     Properties:
       Description: Let lambda get STS creds which allow S3 multipart uplaods
       RoleName: lambda-multipart-upload-sts
       # Set the Role's Trust Relationship
       AssumeRolePolicyDocument:
         Version: "2012-10-17"
         Statement:
           # Allow the Lambda's Execution Role to assume this role
           - Effect: Allow
             Action: sts:AssumeRole
             Principal:
               AWS:
                 Fn::GetAtt: [IamRoleLambdaExecution, Arn]
           # Allow my AWS_PROFILE user to invoke it from the CLI for testing
           - Effect: Allow
             Action: sts:AssumeRole
             Principal:
               AWS: arn:aws:iam::#{AWS::AccountId}:user/chris
       # Allow (multipart) uploads to S3
       Policies:
         # We augment this with a dynamic policy to further restrict in the Lambda
         - PolicyName: S3-multipart-uploads
           PolicyDocument:
             Version: "2012-10-17"
             Statement:
               - Effect: Allow
                 Action: sts:AssumeRole
                 Resource: "*"
               - Effect: Allow
                 Action:
                   - s3:PutObject             # initiate, upload part, finish
                   - s3:AbortMultipartUpload  # stop upload
                 Resource: '#{UploadBucket.Arn}/*'
