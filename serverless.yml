service: multipart-upload-sts
# app and org for use with dashboard.serverless.com
app: getsts
org: vstudios


plugins:
  - serverless-pseudo-parameters

provider:
  name: aws
  runtime: python3.8
  logRetentionInDays: 30        # dont create infinite logs as they cost money
  apiKeys:                      # will be generated by CloudFormation and returned
    - ${self:provider.stage}-client1
    - ${self:provider.stage}-client2
  apiGateway:
    apiKeySourceType: HEADER      # not AUTHORIZER


package:
 exclude:
   - package-lock.json
   - node_modules/**


functions:
  GetSts:
    handler: getsts.get
    events:
      - http:
          path: /
          method: get
          private: true # clients must add "x-api-key: APIKEYVAL" to request headers


resources:
 Resources:
   MultipartUploadRole:
     Type: AWS::IAM::Role
     Properties:
       Description: Let lambda get STS creds which allow S3 multipart uplaods
       RoleName: lambda-multipart-upload-sts
       # Set the Trust Relationship, allowing the lambda to assume this role
       AssumeRolePolicyDocument:
         Version: "2012-10-17"
         Statement:
           - Effect: Allow
             Action: sts:AssumeRole
             Principal:
               Service: lambda.amazonaws.com
           - Effect: Allow
             Action: sts:AssumeRole
             Principal:
               # Can I just get the Arn of IamRoleLambdaExecution
               AWS: arn:aws:iam::#{AWS::AccountId}:role/${self:service}-${self:provider.stage}-#{AWS::Region}-lambdaRole
           - Effect: Allow
             Action: sts:AssumeRole
             Principal:
               AWS: arn:aws:iam::#{AWS::AccountId}:user/chris
       # Allow (multipart) uploads to S3
       Policies:
         - PolicyName: S3-multipart-uploads
           PolicyDocument:
             Version: "2012-10-17"
             Statement:
               - Effect: Allow
                 Action: sts:AssumeRole
                 Resource: "*"
               - Effect: Allow
                 Action:
                   - s3:PutObject
                   - s3:GetObject
                   - s3:AbortMultipartUpload
                   - s3:ListMultipartUploadParts
                 Resource: "arn:aws:s3:::cshenton-multipart-upload-sts-test/*"
  
#  Outputs:
#     NewOutput:
#       Description: "Description for the output"
#       Value: "Some output value"
